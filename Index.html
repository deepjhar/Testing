<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; }
        .container { padding: 20px; }
        .screen { display: none; }
        #loginScreen { display: block; max-width: 400px; margin: 50px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input, textarea, button { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1em; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; background-color: white; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .admin-header h1 { margin: 0; }
        #logoutBtn { background-color: #dc3545; padding: 8px 15px; }
        .admin-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .menu-item { background-color: white; padding: 20px; text-align: center; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; font-weight: bold; }
        .list-item { display: flex; align-items: center; background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .list-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; margin-right: 15px; }
        .list-item .info { flex-grow: 1; }
        .list-item .actions button { width: auto; padding: 5px 10px; font-size: 0.8em; margin-left: 5px; }
        .btn-edit { background-color: #ffc107; }
        .btn-delete { background-color: #dc3545; }
        .back-btn { background-color: #6c757d; margin-top: 15px; }
    </style>
</head>
<body>
    <div id="loginScreen" class="screen">
        <h2>Admin Login</h2>
        <input type="email" id="adminEmail" placeholder="Email">
        <input type="password" id="adminPassword" placeholder="Password">
        <button onclick="adminLogin()">Login</button>
    </div>
    <div id="adminDashboard" class="screen">
        <div class="admin-header"><h1>Dashboard</h1><button id="logoutBtn" onclick="adminLogout()">Logout</button></div>
        <div class="container">
            <div class="admin-menu">
                <div class="menu-item" onclick="prepareAddProduct()">Add Product</div>
                <div class="menu-item" onclick="loadOrders()">Orders</div>
                <div class="menu-item" onclick="loadProductsForEdit()">Edit/Delete</div>
            </div>
        </div>
    </div>
    <div id="addProductScreen" class="screen container">
        <h2 id="formTitle">Add Product</h2>
        <form id="productForm">
            <input type="text" id="productTitle" placeholder="Title" required>
            <textarea id="productDescription" placeholder="Description" rows="4"></textarea>
            <input type="number" id="productPrice" placeholder="Price" required>
            <input type="text" id="productLabel" placeholder="Label (e.g., 90% OFF)">
            <input type="url" id="productCoverImage" placeholder="Cover Image URL (Direct Link)" required>
            <textarea id="productImages" placeholder="Additional Image URLs, comma separated (,)"></textarea>
            <input type="url" id="productFile" placeholder="Downloadable File URL">
        </form>
        <button id="submitProductBtn" onclick="submitProduct()">Add Product</button>
        <button class="back-btn" onclick="showScreen('adminDashboard')">Back to Dashboard</button>
    </div>
    <div id="ordersScreen" class="screen container">
        <h2>Orders</h2><div id="ordersList"></div><button class="back-btn" onclick="showScreen('adminDashboard')">Back</button>
    </div>
    <div id="editDeleteScreen" class="screen container">
        <h2>Edit & Delete Products</h2><div id="editDeleteList"></div><button class="back-btn" onclick="showScreen('adminDashboard')">Back</button>
    </div>
    
    <!-- Updated Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script> <!-- FCM SDK Added -->

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC3KRKS9zXXHfVJnYdZSM_prdcxvfN0gL8",
            authDomain: "aimaster-7ffaf.firebaseapp.com",
            databaseURL: "https://aimaster-7ffaf-default-rtdb.firebaseio.com",
            projectId: "aimaster-7ffaf",
            storageBucket: "aimaster-7ffaf.firebasestorage.app",
            messagingSenderId: "963488826729",
            appId: "1:963488826729:web:0c690774cd50209d33a9f8",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        let editingProductId = null;

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById(screenId).style.display = 'block';
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                showScreen('adminDashboard');
                initializeFCM(); // Initialize FCM after user logs in
            } else {
                showScreen('loginScreen');
            }
        });
        
        // --- FCM PUSH NOTIFICATION CODE STARTS HERE ---
        function initializeFCM() {
            if ('serviceWorker' in navigator && firebase.messaging.isSupported()) {
                const messaging = firebase.messaging();
                messaging.usePublicVapidKey("BJJfIVNxYAOW7uXCkD9YkrWzq6OGt6ybU7jU1LhDk2xtOuU_a33pCed_BAQ3nxcJTYOYhUHeJ5t1CX7Yk9acsm4");

                Notification.requestPermission().then((permission) => {
                    if (permission === 'granted') {
                        console.log('Notification permission granted.');
                        return messaging.getToken();
                    } else {
                        console.warn('Notification permission denied.');
                    }
                }).then(token => {
                    if (token) {
                        console.log('Admin FCM Token:', token);
                        const currentUser = auth.currentUser;
                        if (currentUser) {
                            db.ref('admin_tokens/' + currentUser.uid).set(token);
                        }
                    }
                }).catch((err) => {
                    console.error('An error occurred while setting up notifications.', err);
                });

                messaging.onMessage((payload) => {
                    console.log('Message received in foreground.', payload);
                    alert(`New Order Received!\n\n${payload.notification.title}\n${payload.notification.body}`);
                });
            } else {
                console.warn("Push notifications are not fully supported in this browser.");
            }
        }
        // --- FCM PUSH NOTIFICATION CODE ENDS HERE ---

        function adminLogin() {
            auth.signInWithEmailAndPassword(document.getElementById("adminEmail").value, document.getElementById("adminPassword").value)
            .catch(e => alert(e.message));
        }

        function adminLogout() { 
            const tokenRef = db.ref('admin_tokens/' + auth.currentUser.uid);
            tokenRef.remove();
            auth.signOut(); 
        }

        function prepareAddProduct() {
            editingProductId = null;
            document.getElementById('formTitle').innerText = 'Add Product';
            document.getElementById('submitProductBtn').innerText = 'Add Product';
            document.getElementById('productForm').reset();
            showScreen('addProductScreen');
        }

        function submitProduct() {
            const productData = {
                title: document.getElementById("productTitle").value, description: document.getElementById("productDescription").value,
                price: Number(document.getElementById("productPrice").value), label: document.getElementById("productLabel").value,
                coverImage: document.getElementById("productCoverImage").value, images: document.getElementById("productImages").value.split(',').map(s => s.trim()).filter(Boolean),
                downloadableFile: document.getElementById("productFile").value,
            };
            if (!productData.title || !productData.coverImage) return alert("Title and Cover Image are required.");
            const task = editingProductId ? db.ref('products/' + editingProductId).update(productData) : db.ref('products').push(productData);
            task.then(() => { alert(`Product ${editingProductId ? 'updated' : 'added'}!`); showScreen('adminDashboard'); }).catch(e => alert(e.message));
        }
        
        function loadOrders() {
            db.ref("orders").orderByChild("timestamp").once("value", snapshot => {
                const list = document.getElementById("ordersList");
                list.innerHTML = "";
                let ordersHtml = "";
                snapshot.forEach(child => {
                    const order = child.val(); const orderTime = new Date(order.timestamp).toLocaleString();
                    ordersHtml = `<div class="list-item"><img src="${order.productCoverImage}" alt="${order.productTitle}"><div class="info"><h4>${order.productTitle}</h4><p>â‚¹${order.price} | ${order.userEmail}</p><small>${orderTime}</small></div></div>` + ordersHtml;
                });
                list.innerHTML = ordersHtml; showScreen('ordersScreen');
            });
        }
        
        function loadProductsForEdit() {
            db.ref("products").once("value", snapshot => {
                const list = document.getElementById("editDeleteList");
                list.innerHTML = "";
                snapshot.forEach(child => {
                    const product = child.val();
                    list.innerHTML += `<div class="list-item"><img src="${product.coverImage}" alt="${product.title}"><div class="info"><h4>${product.title}</h4></div><div class="actions"><button class="btn-edit" onclick="editProduct('${child.key}')">Edit</button><button class="btn-delete" onclick="deleteProduct('${child.key}')">Delete</button></div></div>`;
                });
                showScreen('editDeleteScreen');
            });
        }

        function editProduct(productId) {
            db.ref('products/' + productId).once('value', doc => {
                const p = doc.val(); if (!p) return;
                editingProductId = productId;
                document.getElementById('productTitle').value = p.title || ''; document.getElementById('productDescription').value = p.description || '';
                document.getElementById('productPrice').value = p.price || 0; document.getElementById('productLabel').value = p.label || '';
                document.getElementById('productCoverImage').value = p.coverImage || ''; document.getElementById('productImages').value = (p.images || []).join(', ');
                document.getElementById('productFile').value = p.downloadableFile || ''; document.getElementById('formTitle').innerText = 'Edit Product';
                document.getElementById('submitProductBtn').innerText = 'Update Product'; showScreen('addProductScreen');
            });
        }

        function deleteProduct(productId) {
            if (confirm("Are you sure? This cannot be undone.")) {
                db.ref("products/" + productId).remove().then(() => { alert("Product deleted!"); loadProductsForEdit(); }).catch(e => alert(e.message));
            }
        }
    </script>
</body>
</html>
